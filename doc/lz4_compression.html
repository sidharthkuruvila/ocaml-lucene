<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-09-10 Sat 22:03 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LZ4 Compression</title>
<meta name="author" content="Sidharth Kuruvila" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">LZ4 Compression</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgab0a8e1">1. The LZ4 block format</a></li>
<li><a href="#org6d8a074">2. Compression</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgab0a8e1" class="outline-2">
<h2 id="orgab0a8e1"><span class="section-number-2">1.</span> The LZ4 block format</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://github.com/lz4/lz4/blob/dev/doc/lz4_Block_format.md">LZ4 Block Format Description</a>.
</p>


<p>
An lz4 compressed <b>block</b> contains multiple <b>sequences</b>. Each <b>sequence</b> can contain two parts. A literal string which can be copied into the output. And a <b>match</b> which points to a substring in the uncompressed output.
</p>



<div id="org9175130" class="figure">
<p><img src="images/lz4-compressed-block.png" alt="lz4-compressed-block.png" />
</p>
</div>

<p>
A sequence starts with a <b>token</b> byte that contains two 4 bit nibbles.  The lower bits contain the literal's length. Literals of lengths 14 bytes and less can be represented by the nibble. Longer lengths require additional length bytes.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #f5deb3; font-weight: bold;">rec</span> <span style="color: #c678dd;">read_length_bytes</span><span style="color: #dcaeea;"> data</span> <span style="color: #f0e68c;">=</span>
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dcaeea;">b</span> <span style="color: #f0e68c;">=</span> <span style="color: #ECBE7B;">Reader.</span>read_byte data <span style="color: #f5deb3; font-weight: bold;">in</span>
  <span style="color: #51afef;">if</span> b <span style="color: #f0e68c;">&lt;</span> 255 <span style="color: #51afef;">then</span>
    b
  <span style="color: #51afef;">else</span>
    b <span style="color: #f0e68c;">+</span> read_length_bytes data

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #c678dd;">read_length</span><span style="color: #dcaeea;"> length_nibble data</span> <span style="color: #f0e68c;">=</span>
  <span style="color: #51afef;">if</span> length_nibble <span style="color: #f0e68c;">&lt;</span> 15 <span style="color: #51afef;">then</span>
    length_nibble
  <span style="color: #51afef;">else</span>
    length_nibble <span style="color: #f0e68c;">+</span> read_length_bytes data

</pre>
</div>

<p>
If the value of the length nibble is less than 15 no extra bytes are required.
</p>

<div class="org-src-container">
<pre class="src src-ocaml">read_length 14 <span style="color: #f0e68c;">(</span><span style="color: #ECBE7B;">Reader.</span>of_string <span style="color: #98be65;">""</span><span style="color: #f0e68c;">)</span>
</pre>
</div>

<pre class="example">
Line 1, characters 0-11:
1 | read_length 14 (Reader.of_string "");;
    ^^^^^^^^^^^
Error: Unbound value read_length
</pre>



<p>
If the length nibble is 15 an extra byte will be read and added to the total length.
</p>

<div class="org-src-container">
<pre class="src src-ocaml">read_length 15 <span style="color: #f0e68c;">(</span><span style="color: #ECBE7B;">Reader.</span>of_string <span style="color: #98be65;">"\x00"</span><span style="color: #f0e68c;">)</span>
</pre>
</div>

<pre class="example">
Line 1, characters 0-11:
1 | read_length 15 (Reader.of_string "\x00");;
    ^^^^^^^^^^^
Error: Unbound value read_length
</pre>


<p>
If the byte read is 255 then 255 is added to the total length and an extra byte is read.
</p>

<div class="org-src-container">
<pre class="src src-ocaml">read_length 15 <span style="color: #f0e68c;">(</span><span style="color: #ECBE7B;">Reader.</span>of_string <span style="color: #98be65;">"\xFF\x03"</span><span style="color: #f0e68c;">)</span>
</pre>
</div>

<pre class="example">
Line 1, characters 0-11:
1 | read_length 15 (Reader.of_string "\xFF\x03");;
    ^^^^^^^^^^^
Error: Unbound value read_length
</pre>


<p>
Once the length of the lteral is calculated the bytes can be copied from the sequence and appended onto the uncompressed buffer.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #c678dd;">copy_literal</span><span style="color: #dcaeea;"> data length buffer</span> <span style="color: #f0e68c;">=</span>
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dcaeea;">bytes</span> <span style="color: #f0e68c;">=</span> <span style="color: #ECBE7B;">Reader.</span>read_n_bytes data length <span style="color: #f5deb3; font-weight: bold;">in</span>
  <span style="color: #ECBE7B;">Buffer.</span>add_string buffer bytes
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dcaeea;">buffer</span> <span style="color: #f0e68c;">=</span> <span style="color: #ECBE7B;">Buffer.</span>create 0<span style="color: #ff4500;">;;</span>
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dcaeea;">data</span> <span style="color: #f0e68c;">=</span> <span style="color: #ECBE7B;">Reader.</span>of_string <span style="color: #98be65;">"copied literal"</span><span style="color: #ff4500;">;;</span>
copy_literal data 14 buffer<span style="color: #ff4500;">;;</span>
<span style="color: #ECBE7B;">Buffer.</span>contents buffer
</pre>
</div>

<p>
The second part of the sequence is the match. The match copies bytes from the uncompressed buffer and appends them to the bufffer. The bytes are copied from an offest up to 65535 bytes before the current end of the buffer. The match length is calculated in a similar manner to the literal length, using extra match lenght bytes if required.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #c678dd;">copy_match</span><span style="color: #dcaeea;"> match_length_nibble data buffer</span> <span style="color: #f0e68c;">=</span>
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dcaeea;">offset</span> <span style="color: #f0e68c;">=</span> <span style="color: #ECBE7B;">Reader.</span>read_u16_le data <span style="color: #f5deb3; font-weight: bold;">in</span>
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dcaeea;">match_length</span> <span style="color: #f0e68c;">=</span> read_length match_length_nibble data <span style="color: #f5deb3; font-weight: bold;">in</span>
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dcaeea;">matched</span> <span style="color: #f0e68c;">=</span> <span style="color: #ECBE7B;">Buffer.</span>sub buffer <span style="color: #a9a1e1;">~pos</span><span style="color: #f0e68c;">:(</span><span style="color: #ECBE7B;">Buffer.</span>length buffer <span style="color: #f0e68c;">-</span> offset<span style="color: #f0e68c;">)</span> <span style="color: #a9a1e1;">~len</span><span style="color: #f0e68c;">:</span>match_length <span style="color: #f0e68c;">|&gt;</span> <span style="color: #ECBE7B;">Bytes.</span>to_string <span style="color: #f5deb3; font-weight: bold;">in</span>
  <span style="color: #ECBE7B;">Buffer.</span>add_string buffer matched
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dcaeea;">buffer</span> <span style="color: #f0e68c;">=</span> <span style="color: #ECBE7B;">Buffer.</span>create 0<span style="color: #ff4500;">;;</span>
<span style="color: #ECBE7B;">Buffer.</span>add_string buffer <span style="color: #98be65;">"copied match bytes "</span><span style="color: #ff4500;">;;</span>
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dcaeea;">data</span> <span style="color: #f0e68c;">=</span> <span style="color: #ECBE7B;">Reader.</span>of_string <span style="color: #98be65;">"\x13\x00\x03"</span><span style="color: #ff4500;">;;</span>
copy_match 15 data buffer<span style="color: #ff4500;">;;</span>
<span style="color: #ECBE7B;">Buffer.</span>contents buffer
</pre>
</div>

<pre class="example">
copied match bytes 
</pre>
</div>
</div>

<div id="outline-container-org6d8a074" class="outline-2">
<h2 id="org6d8a074"><span class="section-number-2">2.</span> Compression</h2>
<div class="outline-text-2" id="text-2">
<p>
Compression works by finding matching substrings. A hashtable can speed up the search of substrings.
</p>



<div id="orgf376ab9" class="figure">
<p><img src="images/lz4-compression.png" alt="lz4-compression.png" />
</p>
</div>

<p>
In the example the entry in the hash table for the string "cata" points to index 0. The literal "catamaran and " is copied into the first sequence, The prefix "cata" is found in the hash and the string "catamaran" matches the string at index 0. It is used t construct the hash. "s end" is a five character literal that marks the end of the block.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Sidharth Kuruvila</p>
<p class="date">Created: 2022-09-10 Sat 22:03</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
